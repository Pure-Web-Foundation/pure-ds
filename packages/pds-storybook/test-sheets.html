<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test AdoptedStyleSheets</title>
  <style>
    body { font-family: system-ui; padding: 20px; }
    button { margin: 5px; padding: 10px; }
    #log { background: #f5f5f5; padding: 10px; margin-top: 20px; font-family: monospace; white-space: pre; }
  </style>
</head>
<body>
  <h1>AdoptedStyleSheets Test</h1>
  <button id="check">Check Sheets</button>
  <button id="add">Add Sheet</button>
  <button id="clear">Clear All</button>
  <button id="storybook">Simulate Storybook Navigation</button>
  <div id="log"></div>

  <script type="module">
    import { PDS } from '../../src/js/pds.js';

    const log = document.getElementById('log');
    
    function logStatus(label) {
      const sheets = document.adoptedStyleSheets || [];
      const msg = `[${new Date().toLocaleTimeString()}] ${label}\nTotal sheets: ${sheets.length}\nSheet details:\n${sheets.map((s, i) => `  ${i}: ${s.cssRules.length} rules, first: ${s.cssRules[0]?.cssText?.substring(0, 60)}`).join('\n')}`;
      console.log(msg);
      log.textContent = msg + '\n\n' + log.textContent;
    }

    // Initialize PDS
    console.log('Starting PDS...');
    await PDS.start({
      mode: 'live',
      preset: 'retro-wave',
      autoDefine: { baseURL: '/assets/pds/components/' },
      applyGlobalStyles: true
    });
    
    logStatus('After PDS.start()');
    window.designer = PDS.registry._designer;

    document.getElementById('check').onclick = () => {
      logStatus('Manual check');
    };

    document.getElementById('add').onclick = () => {
      const sheet = new CSSStyleSheet();
      sheet.replaceSync('body { color: red; }');
      document.adoptedStyleSheets = [...document.adoptedStyleSheets, sheet];
      logStatus('After adding test sheet');
    };

    document.getElementById('clear').onclick = () => {
      document.adoptedStyleSheets = [];
      logStatus('After clearing all sheets');
    };

    document.getElementById('storybook').onclick = async () => {
      // Simulate what Storybook might be doing
      logStatus('BEFORE clear');
      document.adoptedStyleSheets = [];
      logStatus('AFTER clear (simulating Storybook navigation)');
      
      // Try reapplying
      await PDS.Generator.applyStyles(window.designer);
      logStatus('AFTER reapply');
    };

    // Monitor changes
    let lastCount = document.adoptedStyleSheets.length;
    setInterval(() => {
      const current = document.adoptedStyleSheets.length;
      if (current !== lastCount) {
        logStatus(`⚠️ CHANGE DETECTED (${lastCount} → ${current})`);
        lastCount = current;
      }
    }, 500);
  </script>
</body>
</html>
