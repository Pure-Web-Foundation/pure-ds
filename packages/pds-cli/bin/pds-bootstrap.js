#!/usr/bin/env node

import { readFile, writeFile, mkdir, access } from 'fs/promises';
import { existsSync } from 'fs';
import path from 'path';
import { spawn } from 'child_process';
import { buildStarterPdsConfig } from './templates/starter-templates.js';

const projectRoot = process.cwd();

function log(message) {
  console.log(message);
}

async function ensureDir(dirPath) {
  await mkdir(dirPath, { recursive: true });
}

async function writeFileIfMissing(filePath, content) {
  try {
    await access(filePath);
    log(`‚Ü™Ô∏è  Skipping existing ${path.relative(projectRoot, filePath)}`);
    return false;
  } catch {
    await ensureDir(path.dirname(filePath));
    await writeFile(filePath, content, 'utf8');
    log(`‚úÖ Created ${path.relative(projectRoot, filePath)}`);
    return true;
  }
}

function getNpmCommand() {
  return process.platform === 'win32' ? 'npm.cmd' : 'npm';
}

async function getPdsCoreVersion() {
  try {
    const pkgPath = path.join(projectRoot, 'node_modules', '@pure-ds', 'core', 'package.json');
    const raw = await readFile(pkgPath, 'utf8');
    const pkg = JSON.parse(raw);
    return pkg?.version || 'unknown';
  } catch {
    return 'unknown';
  }
}

async function readPackageJson() {
  const pkgPath = path.join(projectRoot, 'package.json');
  const raw = await readFile(pkgPath, 'utf8');
  return { pkgPath, pkg: JSON.parse(raw) };
}

async function writePackageJson(pkgPath, pkg) {
  await writeFile(pkgPath, JSON.stringify(pkg, null, 2) + '\n');
}

function buildIndexHtml({ version, generatedAt }) {
  return `<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pure Design System</title>

    <!-- PDS Styles -->
    <link rel="stylesheet" href="/assets/css/app.css" />

    <!-- Import Map for Lit components -->
    <script type="importmap">
      {
        "imports": {
          "#pds/lit": "/assets/js/lit.js"
        }
      }
    </script>

    <!-- Dev live-reload (safe in production, no-op without server) -->
    <script type="module" src="/assets/js/dev-reload.js" defer></script>

    <!-- App Script -->
    <script type="module" src="/assets/js/app.js" defer></script>
  </head>

  <body class="container">
    <header class="stack-sm">
      <p class="auto-gen">Auto-generated by PDS ${version} at ${generatedAt}</p>
    </header>

    <main></main>

    <footer class="text-sm text-muted">
      <small>&copy; 2026 Pure Design System</small>
    </footer>
  </body>
</html>
`;
}

function buildDevReloadJs() {
  return `const shouldConnect =
  location.hostname === 'localhost' || location.hostname === '127.0.0.1';

if (shouldConnect) {
  const reloadPort = 4174;
  const endpoint = 'http://localhost:' + reloadPort + '/events';
  const source = new EventSource(endpoint);

  source.onmessage = (event) => {
    if (event.data === 'reload') {
      location.reload();
    }
  };

  source.onerror = () => {
    source.close();
  };
}
`;
}

function buildAppCss() {
  return `html:not(.pds-ready) {
  opacity: 0;
}

main {
  margin: auto;
}

h1 {
  background: linear-gradient(var(--gradient-angle, 135deg),
    var(--color-primary-400),
    var(--color-accent-400)
  );
  background-clip: text;
  -webkit-background-clip: text;
  color: transparent;
}

.container {
  display: grid;
  grid-template-rows: auto 1fr auto;
  height: 100dvh;
  padding: 0;
}

header, footer {
  padding: var(--spacing-4);
}

footer {
  text-align: center;
}

.auto-gen {
  color: var(--color-text-muted);
  font-size: var(--font-size-xs);
}

#settings-btn {
  position: fixed;
  top: var(--spacing-4);
  right: var(--spacing-4);
}

.hero {
  padding: var(--spacing-8);
  zoom: 1.15;
  text-align: center;
  border: var(--border-width-medium) solid transparent;
  background: linear-gradient(var(--color-surface-base), var(--color-surface-base)) padding-box,
    linear-gradient(var(--gradient-angle, 135deg), var(--color-primary-400), var(--color-accent-400)) border-box;
  max-width: var(--max-w-lg);
  border-radius: var(--radius-lg);
  border-width: 3px;
}

.hero > div {
  margin: var(--spacing-10) 0;
}
`;
}

function buildMyHome() {
  return `/**
 * @file my-home.js
 * @description A simple home component for the app.
 */
customElements.define(
  "my-home",
  class extends HTMLElement {
    connectedCallback() {
      this.innerHTML = /*html*/ \`
        <article class="hero">
          <h1>Welcome to your new App</h1>
          <div>
            <p>
              This <code>&lt;my-home&gt;</code> Web Component is lazy-loaded and styled with Pure Design System.
            </p>
            <p>
              You can start building your app by editing the files in <code>public/assets/my/</code> and <code>src/js/</code>.
            </p>
          </div>
          <nav>
            <a target="_blank" href="https://github.com/Pure-Web-Foundation/pure-ds/blob/main/getting-started.md" class="btn btn-primary btn-lg">
              <pds-icon icon="rocket"></pds-icon> Get Started
            </a>
            <a target="_blank" href="https://puredesignsystem.z6.web.core.windows.net/storybook/" class="btn btn-secondary btn-lg">
              <pds-icon icon="book-open"></pds-icon> Storybook
            </a>
          </nav>
        </article>
      \`;
    }
  },
);
`;
}

function buildMyTheme() {
  return `/**
 * my-theme Web Component - allows users to select the app theme (light, dark, system)
 *
 * Uses Pure Design System (PDS) for styling and theming.
 */
customElements.define(
  "my-theme",
  class extends HTMLElement {
    constructor() {
      super();
      this.attachShadow({ mode: "open" });
    }

    async connectedCallback() {
      const componentStyles = PDS.createStylesheet(\`
        :host {
          display: block;
        }
      \`);

      await PDS.adoptLayers(
        this.shadowRoot,
        ["tokens", "primitives", "components", "utilities"],
        [componentStyles],
      );

      this.shadowRoot.innerHTML += /*html*/ \`
        <form>
          <fieldset role="radiogroup" aria-label="Theme" class="buttons">
            <legend>Theme</legend>
            <label>
              <input type="radio" name="theme" value="system">
              <span>
                <pds-icon icon="moon-stars"></pds-icon>
                System
              </span>
            </label>
            <label>
              <input type="radio" name="theme" value="light">
              <span>
                <pds-icon icon="sun"></pds-icon>
                Light
              </span>
            </label>
            <label>
              <input type="radio" name="theme" value="dark">
              <span>
                <pds-icon icon="moon"></pds-icon>
                Dark
              </span>
            </label>
          </fieldset>
        </form>\`;

      this.#updateCheckedState();

      this.shadowRoot.addEventListener("change", (e) => {
        if (e.target.type === "radio" && e.target.name === "theme") {
          PDS.setTheme(e.target.value, { persist: true });
          PDS.toast(\`Theme changed to \${e.target.value}\`, { duration: 2000 });
        }
      });

      const observer = new MutationObserver(() => {
        this.#updateCheckedState();
      });

      observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ["data-theme"],
      });
    }

    #updateCheckedState() {
      const currentTheme = PDS.theme || "system";
      const radios = this.shadowRoot.querySelectorAll('input[type="radio"]');
      radios.forEach((radio) => {
        radio.checked = radio.value === currentTheme;
      });
    }
  },
);
`;
}

function buildAppJs() {
  return `import { PDS } from "@pure-ds/core";
import { config } from "../../pds.config.js";

await PDS.start(config);

const main = document.querySelector("main");
if (main && !main.querySelector("my-home")) {
  main.innerHTML = "<my-home></my-home>";
}

/**
 * Generates an HTML NodeList by parsing the given HTML string
 * @param {String} html
 * @returns {NodeListOf<ChildNode>} DOM element
 */
const parseHTML = (html) => {
  return new DOMParser().parseFromString(html, "text/html").body.childNodes;
};

const settingsBtn = parseHTML(
  /*html*/
  \`\n  <button id="settings-btn" class="icon-only btn-xs btn-outline" aria-label="Settings">\n    <pds-icon icon="gear"></pds-icon>\n  </button>\`,
)[0];

document.body.appendChild(settingsBtn);

const drawer = document.createElement("pds-drawer");
drawer.setAttribute("position", "right");

drawer.innerHTML = /*html*/ \`<div slot="drawer-header">Settings</div>\n  <div slot="drawer-content"><my-theme></my-theme></div>\`;
document.body.appendChild(drawer);

settingsBtn.addEventListener("click", () => {
  drawer.open = true;
});
`;
}

function buildPdsConfig() {
  return buildStarterPdsConfig();
}

function buildEsbuildDevCjs() {
  return `const esbuild = require('esbuild');
const http = require('http');

const reloadPort = 4174;
const reloadClients = new Set();

function startReloadServer() {
  const server = http.createServer((req, res) => {
    if (req.url !== '/events') {
      res.writeHead(404);
      res.end();
      return;
    }

    res.writeHead(200, {
      'Content-Type': 'text/event-stream',
      'Cache-Control': 'no-cache',
      Connection: 'keep-alive',
      'Access-Control-Allow-Origin': '*'
    });

    res.write('retry: 1000\\n\\n');
    reloadClients.add(res);

    req.on('close', () => {
      reloadClients.delete(res);
    });
  });

  server.listen(reloadPort, () => {
    console.log('Live reload listening on http://localhost:' + reloadPort + '/events');
  });
}

function notifyReload() {
  for (const client of reloadClients) {
    client.write('data: reload\\n\\n');
  }
}

function liveReloadPlugin() {
  return {
    name: 'live-reload',
    setup(build) {
      build.onEnd((result) => {
        if (!result.errors.length) {
          notifyReload();
        }
      });
    }
  };
}

async function start() {
  startReloadServer();
  const ctx = await esbuild.context({
    entryPoints: ['src/js/app.js'],
    outdir: 'public/assets/js',
    bundle: true,
    format: 'esm',
    sourcemap: true,
    publicPath: '/assets/js',
    external: ['/assets/my/*'],
    logLevel: 'info',
    plugins: [liveReloadPlugin()]
  });

  await ctx.watch();
  const { host, port } = await ctx.serve({ servedir: 'public', port: 4173 });
  console.log('Dev server running at http://' + host + ':' + port);
}

start().catch((err) => {
  console.error(err);
  process.exit(1);
});
`;
}

function buildEsbuildDevEsm() {
  return `import esbuild from 'esbuild';
import http from 'http';

const reloadPort = 4174;
const reloadClients = new Set();

function startReloadServer() {
  const server = http.createServer((req, res) => {
    if (req.url !== '/events') {
      res.writeHead(404);
      res.end();
      return;
    }

    res.writeHead(200, {
      'Content-Type': 'text/event-stream',
      'Cache-Control': 'no-cache',
      Connection: 'keep-alive',
      'Access-Control-Allow-Origin': '*'
    });

    res.write('retry: 1000\\n\\n');
    reloadClients.add(res);

    req.on('close', () => {
      reloadClients.delete(res);
    });
  });

  server.listen(reloadPort, () => {
    console.log('Live reload listening on http://localhost:' + reloadPort + '/events');
  });
}

function notifyReload() {
  for (const client of reloadClients) {
    client.write('data: reload\\n\\n');
  }
}

function liveReloadPlugin() {
  return {
    name: 'live-reload',
    setup(build) {
      build.onEnd((result) => {
        if (!result.errors.length) {
          notifyReload();
        }
      });
    }
  };
}

startReloadServer();

const ctx = await esbuild.context({
  entryPoints: ['src/js/app.js'],
  outdir: 'public/assets/js',
  bundle: true,
  format: 'esm',
  sourcemap: true,
  publicPath: '/assets/js',
  external: ['/assets/my/*'],
  logLevel: 'info',
  plugins: [liveReloadPlugin()]
});

await ctx.watch();
const { host, port } = await ctx.serve({ servedir: 'public', port: 4173 });
`;
}

async function ensurePackageScripts(pkg, pkgPath) {
  pkg.scripts = pkg.scripts || {};
  let changed = false;

  if (!pkg.scripts.dev) {
    pkg.scripts.dev = 'node esbuild-dev.js';
    changed = true;
  }

  if (!pkg.scripts['pds:bootstrap']) {
    pkg.scripts['pds:bootstrap'] = 'pds-bootstrap';
    changed = true;
  }

  if (changed) {
    await writePackageJson(pkgPath, pkg);
    log('‚úÖ Updated package.json scripts');
  } else {
    log('‚Ü™Ô∏è  package.json scripts already configured');
  }
}

async function ensureEsbuildDependency(pkg, pkgPath) {
  const version = '^0.19.0';
  const hasDev = pkg.devDependencies && pkg.devDependencies.esbuild;
  const hasDep = pkg.dependencies && pkg.dependencies.esbuild;

  if (hasDev || hasDep) {
    log('‚Ü™Ô∏è  esbuild already installed');
    return false;
  }

  const npmCmd = getNpmCommand();
  log('üì¶ Installing esbuild...');

  await new Promise((resolve, reject) => {
    const child = spawn(npmCmd, ['install', '--save-dev', `esbuild@${version}`], {
      cwd: projectRoot,
      stdio: 'inherit',
      shell: true
    });

    child.on('exit', (code) => {
      if (code === 0) resolve();
      else reject(new Error(`npm install failed with code ${code}`));
    });
  });

  const updated = JSON.parse(await readFile(pkgPath, 'utf8'));
  Object.assign(pkg, updated);
  return true;
}

async function runDevServer() {
  const npmCmd = getNpmCommand();
  log('üöÄ Starting dev server...');

  await new Promise((resolve, reject) => {
    const child = spawn(npmCmd, ['run', 'dev'], {
      cwd: projectRoot,
      stdio: 'inherit',
      shell: true
    });

    child.on('exit', (code) => {
      if (code === 0) resolve();
      else reject(new Error(`npm run dev exited with code ${code}`));
    });
  });
}

async function ensurePdsAssets() {
  const pdsAssetsDir = path.join(projectRoot, 'public', 'assets', 'pds');
  if (existsSync(pdsAssetsDir)) {
    log('‚Ü™Ô∏è  PDS assets already present');
    return;
  }

  const npmCmd = getNpmCommand();
  log('üé® Building PDS static assets (pds:build)...');

  await new Promise((resolve, reject) => {
    const child = spawn(npmCmd, ['run', 'pds:build'], {
      cwd: projectRoot,
      stdio: 'inherit',
      shell: true
    });

    child.on('exit', (code) => {
      if (code === 0) resolve();
      else reject(new Error(`npm run pds:build exited with code ${code}`));
    });
  });
}

async function main() {
  log('\n‚ö° PDS Bootstrap\n');

  const { pkgPath, pkg } = await readPackageJson();
  const isModule = pkg.type === 'module';

  await ensurePackageScripts(pkg, pkgPath);
  await ensureEsbuildDependency(pkg, pkgPath);

  const version = await getPdsCoreVersion();
  const generatedAt = new Date().toLocaleString();

  await writeFileIfMissing(
    path.join(projectRoot, 'public', 'index.html'),
    buildIndexHtml({ version, generatedAt })
  );
  await writeFileIfMissing(path.join(projectRoot, 'public', 'assets', 'css', 'app.css'), buildAppCss());
  await writeFileIfMissing(path.join(projectRoot, 'src', 'js', 'app.js'), buildAppJs());
  await writeFileIfMissing(path.join(projectRoot, 'pds.config.js'), buildPdsConfig());
  await writeFileIfMissing(
    path.join(projectRoot, 'public', 'assets', 'js', 'dev-reload.js'),
    buildDevReloadJs()
  );
  await writeFileIfMissing(
    path.join(projectRoot, 'public', 'assets', 'my', 'my-home.js'),
    buildMyHome()
  );
  await writeFileIfMissing(
    path.join(projectRoot, 'public', 'assets', 'my', 'my-theme.js'),
    buildMyTheme()
  );

  const esbuildDevPath = path.join(projectRoot, 'esbuild-dev.js');
  const esbuildDevContent = isModule ? buildEsbuildDevEsm() : buildEsbuildDevCjs();
  await writeFileIfMissing(esbuildDevPath, esbuildDevContent);

  await ensurePdsAssets();

  log('\n‚úÖ Bootstrap files ready.\n');
  await runDevServer();
}

main().catch((err) => {
  console.error('‚ùå Bootstrap failed:', err?.message || err);
  process.exit(1);
});
